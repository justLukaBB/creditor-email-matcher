---
phase: 02-async-job-queue-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/config.py
  - app/actors/__init__.py
  - app/worker.py
  - requirements.txt
autonomous: true
user_setup:
  - service: redis
    why: "Dramatiq message broker"
    env_vars:
      - name: REDIS_URL
        source: "Render Dashboard -> Add Redis add-on -> copy Internal URL"

must_haves:
  truths:
    - "Dramatiq broker initializes with Redis connection"
    - "Worker entrypoint imports actors and configures broker"
    - "Settings include redis_url and worker config"
  artifacts:
    - path: "app/actors/__init__.py"
      provides: "Dramatiq broker singleton and configuration"
      contains: "RedisBroker"
    - path: "app/worker.py"
      provides: "Worker entrypoint for dramatiq CLI"
      contains: "import app.actors"
    - path: "app/config.py"
      provides: "redis_url, worker settings"
      contains: "redis_url"
    - path: "requirements.txt"
      provides: "dramatiq[redis] dependency"
      contains: "dramatiq"
  key_links:
    - from: "app/worker.py"
      to: "app/actors/__init__.py"
      via: "import that registers actors with broker"
      pattern: "import app\\.actors"
    - from: "app/actors/__init__.py"
      to: "app/config.py"
      via: "settings.redis_url for broker connection"
      pattern: "settings\\.redis_url"
---

<objective>
Set up Dramatiq + Redis broker infrastructure, worker entrypoint, and application configuration for async job processing.

Purpose: Foundation layer that all Dramatiq actors depend on. Without broker setup, no actors can be defined or executed.
Output: Working Dramatiq broker configuration, worker entrypoint script, and updated Settings with Redis/worker config.
</objective>

<execution_context>
@/Users/luka.s/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luka.s/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-async-job-queue-infrastructure/02-RESEARCH.md
@.planning/phases/02-async-job-queue-infrastructure/02-CONTEXT.md
@app/config.py
@app/main.py
@app/database.py
@requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dramatiq broker setup and actors package</name>
  <files>app/actors/__init__.py, app/config.py, requirements.txt</files>
  <action>
1. Add `dramatiq[redis]>=2.0.1` and `psutil>=5.9.0` to requirements.txt under a new "# Async Job Queue (Phase 2)" comment section.

2. Update `app/config.py` Settings class to add these fields:
   - `redis_url: Optional[str] = None` -- Redis connection URL
   - `environment: str = "development"` -- already referenced in main.py but not defined; add it
   - `webhook_secret: Optional[str] = None` -- already referenced in webhook.py but not defined; add it
   - `admin_email: Optional[str] = None` -- for failure notifications
   - `smtp_host: Optional[str] = None` -- for email notifications
   - `smtp_port: int = 587`
   - `smtp_username: Optional[str] = None`
   - `smtp_password: Optional[str] = None`
   - `llm_provider: str = "claude"` -- already referenced in webhook.py but not defined
   - `worker_processes: int = 2` -- Dramatiq worker processes
   - `worker_threads: int = 1` -- threads per worker process

3. Create `app/actors/__init__.py` with:
   - Import dramatiq and RedisBroker from dramatiq.brokers.redis
   - Import settings from app.config
   - Create broker setup function `setup_broker()` that:
     - If `settings.redis_url` is set: creates RedisBroker with url=settings.redis_url, namespace="creditor_matcher", max_connections=10, socket_timeout=5, socket_connect_timeout=5, socket_keepalive=True, retry_on_timeout=True, heartbeat_timeout=30000, dead_message_ttl=86400000
     - If not set: uses dramatiq.brokers.stub.StubBroker for testing (import conditionally)
     - Calls dramatiq.set_broker(broker)
     - Returns the broker instance
   - Call setup_broker() at module level so broker is configured on import
   - Add `# Actor imports (registered with broker on import)` comment placeholder -- actual actor imports added in Plan 03
   - Use structlog for logging

IMPORTANT: Do NOT use dramatiq.brokers.redis.RedisBroker() at module level with settings.redis_url directly -- wrap in setup_broker() function so testing can override. But DO call setup_broker() at module level for production use.
  </action>
  <verify>
Run `python -c "from app.config import settings; print(settings.redis_url)"` -- should print None (no env var set).
Run `python -c "from app.actors import broker; print(type(broker))"` -- should print StubBroker (no Redis configured).
  </verify>
  <done>
Settings class includes redis_url, worker_processes, worker_threads, environment, and other missing config fields. app/actors/__init__.py creates Dramatiq broker (RedisBroker when REDIS_URL set, StubBroker otherwise). requirements.txt includes dramatiq[redis] and psutil.
  </done>
</task>

<task type="auto">
  <name>Task 2: Worker entrypoint and startup script</name>
  <files>app/worker.py</files>
  <action>
Create `app/worker.py` as the Dramatiq worker entrypoint:

1. Module docstring explaining usage: `dramatiq app.worker --processes 2 --threads 1`
2. Import app.actors (triggers broker setup)
3. Import structlog, configure basic logging
4. Add a comment block documenting:
   - Procfile usage: `worker: dramatiq app.worker --processes 2 --threads 1 --verbose`
   - Memory budget: ~350MB for workers (512MB total - 150MB FastAPI)
   - Recommended config: 2 processes x 1 thread = 2 concurrent jobs
5. Import all actor modules (placeholder comment for now -- actual import of email_processor added in Plan 03):
   ```python
   # Import actors to register them with the broker
   # from app.actors import email_processor  # Added in Plan 02-03
   ```
6. Add a simple health log on module load:
   ```python
   logger.info("worker_ready", broker=type(broker).__name__)
   ```

This file is the entrypoint for `dramatiq` CLI command. It must import all actors so they register with the broker.
  </action>
  <verify>
Run `python -c "import app.worker"` -- should succeed without errors and log worker_ready message. No Redis connection needed (StubBroker used when REDIS_URL not set).
  </verify>
  <done>
app/worker.py exists, imports app.actors (which sets up broker), and serves as the entrypoint for `dramatiq app.worker` CLI command.
  </done>
</task>

</tasks>

<verification>
- `python -c "from app.config import settings; print(settings.model_fields.keys())"` shows redis_url, worker_processes, worker_threads
- `python -c "from app.actors import broker"` completes without error
- `python -c "import app.worker"` completes without error
- `grep -q 'dramatiq' requirements.txt` succeeds
</verification>

<success_criteria>
- Dramatiq broker singleton configured in app/actors/__init__.py
- Worker entrypoint at app/worker.py importable and ready for actor registration
- Settings extended with Redis URL, worker config, and previously-missing fields
- dramatiq[redis] and psutil added to requirements.txt
</success_criteria>

<output>
After completion, create `.planning/phases/02-async-job-queue-infrastructure/02-01-SUMMARY.md`
</output>
