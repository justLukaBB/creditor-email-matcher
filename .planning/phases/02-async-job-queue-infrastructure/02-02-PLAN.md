---
phase: 02-async-job-queue-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/models/incoming_email.py
  - app/models/webhook_schemas.py
  - alembic/versions/YYYYMMDD_add_job_state_machine.py
autonomous: true

must_haves:
  truths:
    - "IncomingEmail has started_at, completed_at, retry_count, attachment_urls columns"
    - "Webhook schema accepts attachments field with list of URLs"
    - "Alembic migration adds new columns and indexes"
  artifacts:
    - path: "app/models/incoming_email.py"
      provides: "State machine columns for job tracking"
      contains: "started_at"
    - path: "app/models/webhook_schemas.py"
      provides: "Updated Zendesk webhook schema with attachments"
      contains: "attachments"
    - path: "alembic/versions/"
      provides: "Migration for job state machine columns"
  key_links:
    - from: "app/models/incoming_email.py"
      to: "alembic migration"
      via: "model columns match migration columns"
      pattern: "started_at|completed_at|attachment_urls|retry_count"
    - from: "app/models/webhook_schemas.py"
      to: "app/models/incoming_email.py"
      via: "attachments field maps to attachment_urls column"
      pattern: "attachment"
---

<objective>
Add job state machine columns to IncomingEmail model, update webhook schema for attachment URLs, and create Alembic migration.

Purpose: The IncomingEmail table becomes the job tracking table. New columns track job lifecycle (started_at, completed_at, retry_count) and store Zendesk attachment URLs for Phase 3 processing.
Output: Updated model, updated webhook schema, and runnable Alembic migration.
</objective>

<execution_context>
@/Users/luka.s/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luka.s/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-async-job-queue-infrastructure/02-CONTEXT.md
@.planning/phases/02-async-job-queue-infrastructure/02-RESEARCH.md
@app/models/incoming_email.py
@_existing-code/app/models/webhook_schemas.py
@alembic/versions/20260204_1549_add_saga_infrastructure.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update IncomingEmail model with state machine columns</name>
  <files>app/models/incoming_email.py</files>
  <action>
Add the following columns to the IncomingEmail model:

1. **Job state machine timestamps:**
   - `started_at = Column(DateTime(timezone=True), nullable=True)` -- when worker began processing
   - `completed_at = Column(DateTime(timezone=True), nullable=True)` -- when processing finished

2. **Retry tracking:**
   - `retry_count = Column(Integer, default=0, nullable=False)` -- how many times Dramatiq has retried this job

3. **Attachment URLs (Phase 2 schema prep for Phase 3):**
   - `attachment_urls = Column(JSON, nullable=True)` -- list of attachment URLs from Zendesk webhook
   Example: `[{"url": "https://...", "filename": "rechnung.pdf", "content_type": "application/pdf", "size": 12345}]`

4. **Update processing_status comment** to document the full state machine:
   ```python
   # State machine: received -> queued -> processing -> completed | failed
   # received: webhook validated and email stored
   # queued: enqueued to Dramatiq for async processing
   # processing: worker picked up and is processing
   # completed: successfully finished
   # failed: permanently failed (all retries exhausted)
   ```

Do NOT remove any existing columns. Only add new ones.
Do NOT change the existing sync_status, sync_error, sync_retry_count columns from Phase 1.
  </action>
  <verify>
Run `python -c "from app.models.incoming_email import IncomingEmail; print([c.name for c in IncomingEmail.__table__.columns])"` -- should include started_at, completed_at, retry_count, attachment_urls alongside all existing columns.
  </verify>
  <done>
IncomingEmail model has started_at, completed_at, retry_count, and attachment_urls columns. All existing columns preserved. State machine documented in comments.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update webhook schema and create Alembic migration</name>
  <files>app/models/webhook_schemas.py, alembic/versions/YYYYMMDD_add_job_state_machine.py</files>
  <action>
**Part A: Copy and update webhook_schemas.py**

The webhook_schemas.py currently only exists in _existing-code/app/models/webhook_schemas.py. It needs to be in the main app/models/ directory. Copy it there and add the attachments field:

1. Copy `_existing-code/app/models/webhook_schemas.py` to `app/models/webhook_schemas.py`
2. Add to ZendeskWebhookEmail:
   ```python
   attachments: Optional[List[dict]] = Field(
       default=None,
       description="List of attachment metadata from Zendesk. Each dict has: url, filename, content_type, size"
   )
   ```
   Each attachment dict expected structure: `{"url": "https://...", "filename": "rechnung.pdf", "content_type": "application/pdf", "size": 12345}`

3. Keep the `class Config: extra = "allow"` setting -- this ensures backward compatibility with Zendesk payloads that may not include attachments.

**Part B: Create manual Alembic migration**

Create migration file at `alembic/versions/YYYYMMDD_HHMM_add_job_state_machine.py` (use current date/time in filename):

```python
"""Add job state machine fields and attachment URLs to incoming_emails

Adds: started_at, completed_at (timestamps for job lifecycle tracking)
Adds: retry_count (Dramatiq retry tracking)
Adds: attachment_urls (Zendesk attachment URLs for Phase 3)
Adds: index on (processing_status, received_at) for job queue queries
"""

revision = 'GENERATE_UNIQUE_ID'
down_revision = 'PREVIOUS_MIGRATION_ID'  # Get from existing migration file

def upgrade():
    op.add_column('incoming_emails',
        sa.Column('started_at', sa.DateTime(timezone=True), nullable=True))
    op.add_column('incoming_emails',
        sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True))
    op.add_column('incoming_emails',
        sa.Column('retry_count', sa.Integer(), server_default='0', nullable=False))
    op.add_column('incoming_emails',
        sa.Column('attachment_urls', sa.JSON(), nullable=True))

    # Index for efficient job status queries (worker polling, status API)
    op.create_index(
        'ix_incoming_emails_status_received',
        'incoming_emails',
        ['processing_status', 'received_at']
    )

def downgrade():
    op.drop_index('ix_incoming_emails_status_received', 'incoming_emails')
    op.drop_column('incoming_emails', 'attachment_urls')
    op.drop_column('incoming_emails', 'retry_count')
    op.drop_column('incoming_emails', 'completed_at')
    op.drop_column('incoming_emails', 'started_at')
```

Use the existing migration's revision ID as down_revision. Read the existing migration file to get its revision ID. Generate a short unique revision ID (8 hex chars).

Follow the project convention of manual migrations (per Phase 1 decision: no autogenerate).
  </action>
  <verify>
Run `python -c "from app.models.webhook_schemas import ZendeskWebhookEmail; print(ZendeskWebhookEmail.model_fields.keys())"` -- should include 'attachments'.
Run `python -c "from alembic.config import Config; from alembic import command; c = Config('alembic.ini'); command.heads(c)"` -- should show new migration as head (may fail without DB, which is OK).
Check migration file exists: `ls alembic/versions/*job_state_machine*`.
  </verify>
  <done>
webhook_schemas.py exists in app/models/ with attachments field. Alembic migration adds started_at, completed_at, retry_count, attachment_urls columns and composite index to incoming_emails table.
  </done>
</task>

</tasks>

<verification>
- IncomingEmail model has all new columns: started_at, completed_at, retry_count, attachment_urls
- ZendeskWebhookEmail schema has attachments field
- Alembic migration file exists with correct up/down operations
- All existing model columns preserved (backward compatible)
</verification>

<success_criteria>
- IncomingEmail model tracks full job lifecycle (received -> queued -> processing -> completed/failed) with timestamps
- Webhook schema accepts Zendesk attachment URLs (stored for Phase 3 processing)
- Migration is ready to run with `alembic upgrade head`
</success_criteria>

<output>
After completion, create `.planning/phases/02-async-job-queue-infrastructure/02-02-SUMMARY.md`
</output>
