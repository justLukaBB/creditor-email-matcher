---
phase: 04-german-document-extraction
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/services/extraction/pdf_extractor.py
  - app/services/extraction/image_extractor.py
autonomous: true

must_haves:
  truths:
    - "Claude Vision prompts are in German with German examples"
    - "Prompts accept German synonyms (Schulden, offener Betrag) not just Gesamtforderung"
    - "Prompts include realistic creditor response examples"
    - "PDF extractor uses German prompt for Claude Vision calls"
    - "Image extractor uses German prompt for Claude Vision calls"
  artifacts:
    - path: "app/services/extraction/pdf_extractor.py"
      provides: "German EXTRACTION_PROMPT constant"
      contains: "Analysiere dieses deutsche"
    - path: "app/services/extraction/image_extractor.py"
      provides: "German IMAGE_EXTRACTION_PROMPT constant"
      contains: "Analysiere dieses Bild"
  key_links:
    - from: "app/services/extraction/pdf_extractor.py"
      to: "Claude API"
      via: "German prompt in messages"
      pattern: "EXTRACTION_PROMPT.*Analysiere"
---

<objective>
Update Claude Vision prompts to use German language with German examples for better extraction accuracy.

Purpose: USER DECISION - German prompts with German examples improve extraction accuracy for German creditor documents. Claude performs better when prompt language matches document language.

Output: Updated EXTRACTION_PROMPT in pdf_extractor.py and IMAGE_EXTRACTION_PROMPT in image_extractor.py using German with realistic German creditor examples.
</objective>

<execution_context>
@/Users/luka.s/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luka.s/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-german-document-extraction/04-CONTEXT.md
@.planning/phases/04-german-document-extraction/04-RESEARCH.md
@app/services/extraction/pdf_extractor.py
@app/services/extraction/image_extractor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update PDF extractor with German Claude prompt</name>
  <files>
    app/services/extraction/pdf_extractor.py
  </files>
  <action>
Update the EXTRACTION_PROMPT constant in `app/services/extraction/pdf_extractor.py` to use German language with German examples.

Replace the existing English prompt with:

```python
# Claude Vision extraction prompt for scanned PDFs (German - USER DECISION)
EXTRACTION_PROMPT = """Analysiere dieses deutsche Glaeuigerdokument und extrahiere die folgenden Informationen.

WICHTIGE REGELN:
1. Suche nach "Gesamtforderung" (Hauptbetrag) - dies ist der wichtigste Betrag
2. Akzeptiere auch Synonyme: "Forderungshoehe", "offener Betrag", "Gesamtsumme", "Schulden", "Restschuld"
3. Deutsche Zahlenformatierung: 1.234,56 EUR bedeutet 1234.56
4. Wenn keine explizite Gesamtforderung: Summiere "Hauptforderung" + "Zinsen" + "Kosten"

BEISPIELE (typische Formulierungen in Glaeubiger-Antworten):
- "Die Gesamtforderung betraegt 1.234,56 EUR" -> gesamtforderung: 1234.56
- "Offener Betrag: 2.500,00 EUR" -> gesamtforderung: 2500.00
- "Restschuld per 01.01.2026: 3.456,78 EUR" -> gesamtforderung: 3456.78
- "Hauptforderung 1.000 EUR, Zinsen 150,50 EUR, Kosten 84,00 EUR" -> gesamtforderung: 1234.50 (Summe)

EXTRAHIERE:
1. gesamtforderung: Gesamtforderungsbetrag in EUR (nur Zahl, z.B. 1234.56)
2. glaeubiger: Name des Glaeubigerers/der Firma (z.B. "XY Inkasso GmbH", "ABC Bank AG")
3. schuldner: Name des Schuldners/Kunden (z.B. "Max Mustermann", "Maria Mueller")
4. components: Falls Gesamtforderung nicht explizit, gib Aufschluesselung an

Gib NUR valides JSON in diesem exakten Format zurueck:
{
  "gesamtforderung": 1234.56,
  "glaeubiger": "Firmenname",
  "schuldner": "Kundenname",
  "components": {
    "hauptforderung": 1000.00,
    "zinsen": 150.56,
    "kosten": 84.00
  }
}

Wenn ein Feld nicht gefunden wird, nutze null. Fuer gesamtforderung gib null nur zurueck, wenn gar keine Betraege gefunden werden."""
```

Key changes from English version:
- Prompt language is German (USER DECISION)
- Accepts German synonyms: Schulden, offener Betrag, Gesamtsumme, Restschuld (USER DECISION)
- Includes realistic German creditor response examples
- Uses German number format explanation (1.234,56 EUR)
- German field names in JSON (but keys remain English for code compatibility)

Note: Use ASCII-safe characters (ae, oe, ue instead of Umlauts in prompt text) to avoid encoding issues in prompts.
  </action>
  <verify>
python -c "from app.services.extraction.pdf_extractor import EXTRACTION_PROMPT; print('Analysiere' in EXTRACTION_PROMPT, 'Schulden' in EXTRACTION_PROMPT)"
  </verify>
  <done>
EXTRACTION_PROMPT is now in German with German examples. Accepts synonyms for Gesamtforderung. Uses realistic German creditor response examples.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Image extractor with German Claude prompt</name>
  <files>
    app/services/extraction/image_extractor.py
  </files>
  <action>
Update the IMAGE_EXTRACTION_PROMPT constant in `app/services/extraction/image_extractor.py` to use German language with German examples.

Replace the existing English prompt with:

```python
# Claude Vision extraction prompt for images (German - USER DECISION)
IMAGE_EXTRACTION_PROMPT = """Analysiere dieses Bild eines deutschen Glaeubiger-/Inkassodokuments.

Extrahiere die folgenden Informationen, falls sichtbar:
1. Gesamtforderung (Gesamtbetrag) - suche nach Waehrungsbetraegen in EUR
2. Falls kein Gesamtbetrag: Summiere Hauptforderung + Zinsen + Kosten
3. Glaeubiger (Name des Glaeubigerers/der Firma)
4. Schuldner (Name des Schuldners/Kunden)

WICHTIG:
- Akzeptiere Synonyme: "Schulden", "offener Betrag", "Restschuld", "Forderungshoehe"
- Deutsche Zahlenformatierung: 1.234,56 EUR bedeutet 1234.56
- Bei unleserlichen Stellen: null zurueckgeben statt raten

BEISPIELE:
- "Gesamtforderung: 1.234,56 EUR" -> 1234.56
- "Offener Betrag per 01.01.2026: 2.500 EUR" -> 2500.00

Gib NUR valides JSON zurueck:
{
  "gesamtforderung": 1234.56,
  "glaeubiger": "Firmenname",
  "schuldner": "Personenname"
}

Falls die Information nicht sichtbar ist oder das Bild kein relevantes Dokument zeigt:
{"gesamtforderung": null, "glaeubiger": null, "schuldner": null}"""
```

Key changes from English version:
- Prompt language is German (USER DECISION)
- Accepts German synonyms (USER DECISION)
- Includes example German creditor phrases
- Instruction to return null for unclear text rather than guessing
- Uses German number format explanation

Note: Use ASCII-safe characters (ae, oe, ue instead of Umlauts) to avoid encoding issues.
  </action>
  <verify>
python -c "from app.services.extraction.image_extractor import IMAGE_EXTRACTION_PROMPT; print('Analysiere' in IMAGE_EXTRACTION_PROMPT, 'Schulden' in IMAGE_EXTRACTION_PROMPT)"
  </verify>
  <done>
IMAGE_EXTRACTION_PROMPT is now in German with German examples. Accepts synonyms. Uses realistic creditor response patterns.
  </done>
</task>

</tasks>

<verification>
1. Run: `python -c "from app.services.extraction.pdf_extractor import EXTRACTION_PROMPT; print(EXTRACTION_PROMPT[:100])"`
2. Run: `python -c "from app.services.extraction.image_extractor import IMAGE_EXTRACTION_PROMPT; print(IMAGE_EXTRACTION_PROMPT[:100])"`
3. Verify both prompts contain "Analysiere" (German)
4. Verify both prompts contain synonym list including "Schulden"
</verification>

<success_criteria>
- EXTRACTION_PROMPT in pdf_extractor.py is in German
- IMAGE_EXTRACTION_PROMPT in image_extractor.py is in German
- Both prompts accept German synonyms (Schulden, offener Betrag, Restschuld)
- Both prompts include realistic German creditor response examples
- Both prompts explain German number format (1.234,56 EUR)
- Existing extraction logic (JSON parsing) unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/04-german-document-extraction/04-03-SUMMARY.md`
</output>
