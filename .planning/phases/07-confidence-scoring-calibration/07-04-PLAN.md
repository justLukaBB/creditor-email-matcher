---
phase: 07-confidence-scoring-calibration
plan: 04
type: execute
wave: 3
depends_on: ["07-02", "07-03"]
files_modified:
  - app/actors/email_processor.py
  - app/services/validation/review_queue.py
  - app/models/incoming_email.py
  - alembic/versions/20260205_2330_add_confidence_columns.py
autonomous: true

must_haves:
  truths:
    - "Email processor computes overall confidence using dimensions"
    - "Routing decision based on confidence determines processing path"
    - "HIGH confidence emails auto-update with log only"
    - "MEDIUM confidence emails write then notify review team"
    - "LOW confidence emails route to manual review queue with expiration"
    - "Confidence breakdown stored in email record"
  artifacts:
    - path: "app/actors/email_processor.py"
      provides: "Integrated confidence-based routing"
      contains: "calculate_overall_confidence"
    - path: "app/models/incoming_email.py"
      provides: "Confidence dimension columns"
      contains: "extraction_confidence"
    - path: "alembic/versions/20260205_2330_add_confidence_columns.py"
      provides: "Migration for confidence columns"
      contains: "extraction_confidence"
  key_links:
    - from: "app/actors/email_processor.py"
      to: "app/services/confidence/overall.py"
      via: "imports confidence calculator"
      pattern: "calculate_overall_confidence"
    - from: "app/actors/email_processor.py"
      to: "app/services/confidence/router.py"
      via: "imports router"
      pattern: "route_by_confidence"
---

<objective>
Integrate confidence scoring and routing into email processing pipeline

Purpose: Replace the existing hardcoded confidence handling with the new multi-dimensional confidence system, enabling three-tier routing based on calibrated thresholds.

Output:
- Email processor uses overall confidence with dimension breakdown
- Three routing paths implemented (auto-update, update+notify, manual review)
- Confidence dimensions stored in email record for analysis
</objective>

<execution_context>
@/Users/luka.s/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luka.s/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-confidence-scoring-calibration/07-CONTEXT.md
@app/actors/email_processor.py
@app/services/confidence/overall.py
@app/services/confidence/router.py
@app/models/incoming_email.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add confidence columns and migration</name>
  <files>
    app/models/incoming_email.py
    alembic/versions/20260205_2330_add_confidence_columns.py
  </files>
  <action>
Add columns to IncomingEmail to store confidence dimension breakdown for analysis and threshold tuning.

1. Update `app/models/incoming_email.py`:
Add after existing match_confidence column:

```python
# Confidence Scoring (Phase 7: Confidence Scoring & Calibration)
extraction_confidence = Column(Integer, nullable=True)  # 0-100, extraction dimension
# Note: match_confidence already exists (from Phase 6)
overall_confidence = Column(Integer, nullable=True)  # 0-100, min(extraction, match)
confidence_route = Column(String(20), nullable=True)  # high, medium, low
# Documents the routing decision made for this email
```

2. Create migration `alembic/versions/20260205_2330_add_confidence_columns.py`:

```python
"""Add confidence scoring columns to incoming_emails

Revision ID: 20260205_2330
Revises: 20260205_2300  # Depends on calibration_samples migration
Create Date: 2026-02-05
"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '20260205_2330'
down_revision = '20260205_2300'  # After calibration_samples
branch_labels = None
depends_on = None


def upgrade():
    # Add confidence dimension columns
    op.add_column(
        'incoming_emails',
        sa.Column('extraction_confidence', sa.Integer(), nullable=True)
    )
    op.add_column(
        'incoming_emails',
        sa.Column('overall_confidence', sa.Integer(), nullable=True)
    )
    op.add_column(
        'incoming_emails',
        sa.Column('confidence_route', sa.String(20), nullable=True)
    )

    # Index for confidence-based queries (e.g., find all LOW confidence items)
    op.create_index(
        'idx_incoming_emails_confidence_route',
        'incoming_emails',
        ['confidence_route', 'created_at']
    )


def downgrade():
    op.drop_index('idx_incoming_emails_confidence_route', 'incoming_emails')
    op.drop_column('incoming_emails', 'confidence_route')
    op.drop_column('incoming_emails', 'overall_confidence')
    op.drop_column('incoming_emails', 'extraction_confidence')
```
  </action>
  <verify>
alembic upgrade head && python -c "from app.models import IncomingEmail; print(hasattr(IncomingEmail, 'extraction_confidence'))"
  </verify>
  <done>
- IncomingEmail has extraction_confidence, overall_confidence, confidence_route columns
- Migration adds columns with index on confidence_route
- Columns nullable for backward compatibility with existing data
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate confidence routing into email processor</name>
  <files>
    app/actors/email_processor.py
    app/services/validation/review_queue.py
  </files>
  <action>
Refactor email_processor.py to use the new confidence scoring and routing system.

1. Read current email_processor.py to understand the flow (already done in context gathering).

2. Add imports at the top of email_processor.py:
```python
from app.services.confidence import (
    calculate_overall_confidence,
    calculate_extraction_confidence,
    calculate_match_confidence,
    route_by_confidence,
    RoutingAction,
    get_review_expiration_days
)
```

3. After MatchingEngineV2 processing (around line 480), REPLACE the existing routing logic with:

```python
# ========================================
# PHASE 7: Confidence Scoring & Routing
# ========================================

# Collect document types from extraction
extraction_checkpoint = (email.agent_checkpoints or {}).get("agent_2_extraction", {})
document_types = extraction_checkpoint.get("source_types", ["email_body"])

# Calculate overall confidence with dimension breakdown
confidence_result = calculate_overall_confidence(
    agent_checkpoints=email.agent_checkpoints,
    document_types=document_types,
    match_result={
        "status": matching_result.status,
        "total_score": matching_result.match.total_score if matching_result.match else 0,
        "candidates": len(matching_result.candidates)
    } if matching_result else None
)

# Store confidence breakdown
email.extraction_confidence = int(confidence_result.extraction * 100)
email.overall_confidence = int(confidence_result.overall * 100)
# Note: match_confidence already set from matching_result

# Determine routing
route = route_by_confidence(confidence_result.overall)
email.confidence_route = route.level.value

logger.info(
    "confidence_routing_determined",
    email_id=email_id,
    overall=confidence_result.overall,
    extraction=confidence_result.extraction,
    match=confidence_result.match,
    weakest_link=confidence_result.weakest_link,
    route=route.action.value
)

# Execute routing action
if route.action == RoutingAction.AUTO_UPDATE:
    # HIGH confidence: auto-update with log only, no notification
    # (existing auto_matched flow, but skip notification)
    # ... existing DualDatabaseWriter flow ...
    # Do NOT call email_notifier.send_debt_update_notification
    logger.info("high_confidence_auto_update", email_id=email_id)

elif route.action == RoutingAction.UPDATE_AND_NOTIFY:
    # MEDIUM confidence: write to database, then notify review team
    # (existing auto_matched flow WITH notification)
    # ... existing DualDatabaseWriter flow ...
    # CALL email_notifier to notify review team for verification
    logger.info("medium_confidence_update_and_notify", email_id=email_id)

elif route.action == RoutingAction.MANUAL_REVIEW:
    # LOW confidence: route to manual review queue with expiration
    from app.services.validation import enqueue_for_review
    expiration_days = get_review_expiration_days(route.level)

    enqueue_for_review(
        db,
        email_id,
        reason="low_confidence",
        details={
            "overall_confidence": confidence_result.overall,
            "extraction_confidence": confidence_result.extraction,
            "match_confidence": confidence_result.match,
            "weakest_link": confidence_result.weakest_link,
            "expiration_days": expiration_days
        }
    )
    email.match_status = "needs_review"
    logger.info("low_confidence_manual_review", email_id=email_id, expiration_days=expiration_days)
```

4. IMPORTANT: The existing matching_result status handling (auto_matched vs ambiguous) should be PRESERVED but MODIFIED:
   - If matching_result.status == "auto_matched" AND route.action == AUTO_UPDATE:
     Do the DualDatabaseWriter flow WITHOUT notification
   - If matching_result.status == "auto_matched" AND route.action == UPDATE_AND_NOTIFY:
     Do the DualDatabaseWriter flow WITH notification
   - If matching_result.status in (ambiguous, below_threshold, no_recent_inquiry) OR route.action == MANUAL_REVIEW:
     Enqueue to manual review (existing behavior)

5. Update `app/services/validation/review_queue.py`:
   - Add optional `expiration_days` parameter to enqueue_for_review
   - Store expiration info in review_details JSONB for future implementation of expiration logic

The key insight: confidence routing MODIFIES the behavior of existing status handling, not replaces it.
  </action>
  <verify>
python -c "from app.actors.email_processor import process_email; print('processor ok')"
  </verify>
  <done>
- Email processor calculates overall confidence with dimension breakdown
- Confidence breakdown stored in email record (extraction_confidence, overall_confidence, confidence_route)
- HIGH confidence: auto-update with log only (no notification)
- MEDIUM confidence: auto-update WITH notification to review team
- LOW confidence: enqueue to manual review with expiration info
- Existing matching status handling preserved and enhanced with confidence routing
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `alembic current` shows latest migration
2. `python -c "from app.models import IncomingEmail; e = IncomingEmail(); print(hasattr(e, 'extraction_confidence'))"`
3. `python -c "from app.actors.email_processor import process_email; print('imports ok')"`
4. Grep for confidence integration: `grep -c "calculate_overall_confidence\|route_by_confidence" app/actors/email_processor.py`
5. Verify routing logic: `grep -A5 "RoutingAction.AUTO_UPDATE" app/actors/email_processor.py`
</verification>

<success_criteria>
- IncomingEmail stores extraction_confidence, overall_confidence, confidence_route
- Email processor computes confidence using dimension calculators
- Routing decision logged with full context (dimensions, weakest link)
- HIGH confidence (>0.85): auto-update, log only, NO notification
- MEDIUM confidence (0.6-0.85): auto-update WITH notification for verification
- LOW confidence (<0.6): manual review queue with expiration info
- Existing matching status handling preserved (ambiguous still goes to review)
- All confidence values stored as integers 0-100 for consistency
</success_criteria>

<output>
After completion, create `.planning/phases/07-confidence-scoring-calibration/07-04-SUMMARY.md`
</output>
