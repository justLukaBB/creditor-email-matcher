---
phase: 07-confidence-scoring-calibration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - app/services/confidence/overall.py
  - app/services/confidence/router.py
  - app/services/confidence/__init__.py
  - app/config.py
autonomous: true

must_haves:
  truths:
    - "Overall confidence is min(extraction_confidence, match_confidence)"
    - "HIGH threshold (>0.85) routes to auto-update with log-only"
    - "MEDIUM threshold (0.6-0.85) routes to write + notify"
    - "LOW threshold (<0.6) routes to manual review queue"
    - "Thresholds are configurable via environment variables"
  artifacts:
    - path: "app/services/confidence/overall.py"
      provides: "Overall confidence calculator using weakest-link"
      exports: ["calculate_overall_confidence"]
    - path: "app/services/confidence/router.py"
      provides: "Confidence-based routing logic"
      exports: ["route_by_confidence", "ConfidenceRoute"]
    - path: "app/config.py"
      provides: "Threshold configuration"
      contains: "confidence_high_threshold"
  key_links:
    - from: "app/services/confidence/overall.py"
      to: "dimensions.py"
      via: "imports dimension calculators"
      pattern: "calculate_extraction_confidence|calculate_match_confidence"
    - from: "app/services/confidence/router.py"
      to: "app/config.py"
      via: "reads threshold settings"
      pattern: "settings\\.confidence"
---

<objective>
Implement overall confidence calculation and three-tier routing

Purpose: Combine extraction and match confidence using weakest-link principle, then route emails to appropriate handling (auto-update, update+notify, or manual review) based on configurable thresholds.

Output:
- Overall confidence calculator with weakest-link (min) logic
- Routing service with three tiers (HIGH/MEDIUM/LOW)
- Threshold configuration via environment variables
</objective>

<execution_context>
@/Users/luka.s/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luka.s/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-confidence-scoring-calibration/07-CONTEXT.md
@app/services/confidence/dimensions.py
@app/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create overall confidence calculator</name>
  <files>
    app/services/confidence/overall.py
    app/services/confidence/__init__.py
  </files>
  <action>
Create the overall confidence calculator that combines all confidence dimensions using the weakest-link principle.

1. Create `app/services/confidence/overall.py`:

```python
"""
Overall Confidence Calculator
Combines confidence dimensions using weakest-link (min) principle

REQ-CONFIDENCE-02: Overall confidence = min(all_stages)
"""

from typing import Dict, Any, Optional, List
from dataclasses import dataclass
import structlog

from app.services.confidence.dimensions import (
    calculate_extraction_confidence,
    calculate_match_confidence
)

logger = structlog.get_logger(__name__)


@dataclass
class OverallConfidence:
    """Result of overall confidence calculation with breakdown"""
    overall: float  # Final confidence score (weakest-link)
    extraction: float  # Extraction dimension
    match: float  # Match dimension
    intent: Optional[float]  # Intent classification (if included)
    dimensions_used: List[str]  # Which dimensions contributed
    weakest_link: str  # Which dimension was the bottleneck


def calculate_overall_confidence(
    agent_checkpoints: Optional[Dict[str, Any]],
    document_types: List[str],
    match_result: Optional[Dict[str, Any]],
    include_intent: bool = False
) -> OverallConfidence:
    """
    Calculate overall confidence using weakest-link principle.

    USER DECISION from CONTEXT.md: overall_confidence = min(all_stages)

    Claude's Discretion: Whether to include intent classification confidence
    - Default: exclude intent (intent classification is binary enough that
      confidence < 0.7 already triggers needs_review in Phase 5)
    - If include_intent=True, factor it in

    Args:
        agent_checkpoints: JSONB from IncomingEmail.agent_checkpoints
        document_types: List of source types processed (native_pdf, scanned_pdf, etc.)
        match_result: Dict from MatchingEngineV2 or None
        include_intent: Whether to factor in intent classification confidence

    Returns:
        OverallConfidence with breakdown of all dimensions
    """
    dimensions = {}
    dimensions_used = []

    # Calculate extraction confidence
    extraction_conf = calculate_extraction_confidence(agent_checkpoints, document_types)
    dimensions["extraction"] = extraction_conf
    dimensions_used.append("extraction")

    # Calculate match confidence
    match_conf = calculate_match_confidence(match_result)
    dimensions["match"] = match_conf
    dimensions_used.append("match")

    # Optionally include intent confidence
    intent_conf = None
    if include_intent and agent_checkpoints:
        intent_checkpoint = agent_checkpoints.get("agent_1_intent", {})
        intent_conf = intent_checkpoint.get("confidence", 0.0)
        if intent_conf > 0:
            dimensions["intent"] = intent_conf
            dimensions_used.append("intent")

    # Weakest-link: overall = min(all dimensions)
    if not dimensions:
        overall = 0.0
        weakest = "none"
    else:
        overall = min(dimensions.values())
        weakest = min(dimensions, key=dimensions.get)

    result = OverallConfidence(
        overall=overall,
        extraction=extraction_conf,
        match=match_conf,
        intent=intent_conf,
        dimensions_used=dimensions_used,
        weakest_link=weakest
    )

    logger.info(
        "overall_confidence_calculated",
        overall=result.overall,
        extraction=result.extraction,
        match=result.match,
        intent=result.intent,
        weakest_link=result.weakest_link
    )

    return result
```

2. Update `app/services/confidence/__init__.py`:
   - Add import for calculate_overall_confidence, OverallConfidence
   - Update __all__ to include new exports
  </action>
  <verify>
python -c "from app.services.confidence import calculate_overall_confidence, OverallConfidence; print('overall ok')"
  </verify>
  <done>
- calculate_overall_confidence uses min() across extraction and match dimensions
- Returns OverallConfidence dataclass with full breakdown
- Identifies which dimension was the weakest link (bottleneck)
- Optional intent confidence inclusion (default excluded)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create routing service with threshold config</name>
  <files>
    app/services/confidence/router.py
    app/services/confidence/__init__.py
    app/config.py
  </files>
  <action>
Create the confidence-based routing service and add threshold configuration to settings.

1. Update `app/config.py`:
Add confidence threshold settings (keep existing settings, add new ones):

```python
# Confidence Routing Configuration (Phase 7)
# USER DECISION: Global thresholds only, stored in env vars
confidence_high_threshold: float = 0.85  # Above this = auto-update, log only
confidence_low_threshold: float = 0.60   # Below this = manual review queue
# Note: MEDIUM is between LOW and HIGH thresholds
```

2. Create `app/services/confidence/router.py`:

```python
"""
Confidence-Based Router
Routes emails to appropriate handling based on confidence thresholds

REQ-CONFIDENCE-03: Confidence-based routing
- High (>0.85): auto-update database, log only, no notification
- Medium (0.6-0.85): write to database, notify review team for verification
- Low (<0.6): route to manual review queue, 7-day expiration
"""

from enum import Enum
from typing import Optional
from dataclasses import dataclass
import structlog

from app.config import settings

logger = structlog.get_logger(__name__)


class ConfidenceLevel(str, Enum):
    """Confidence tier for routing decisions"""
    HIGH = "high"      # > 0.85 (configurable)
    MEDIUM = "medium"  # 0.6 - 0.85
    LOW = "low"        # < 0.6


class RoutingAction(str, Enum):
    """What action to take based on confidence"""
    AUTO_UPDATE = "auto_update"           # HIGH: write + log only
    UPDATE_AND_NOTIFY = "update_and_notify"  # MEDIUM: write + notify review team
    MANUAL_REVIEW = "manual_review"       # LOW: enqueue for human review


@dataclass
class ConfidenceRoute:
    """Routing decision with full context"""
    level: ConfidenceLevel
    action: RoutingAction
    confidence: float
    high_threshold: float
    low_threshold: float
    reason: str  # Human-readable explanation


def route_by_confidence(
    overall_confidence: float,
    high_threshold: Optional[float] = None,
    low_threshold: Optional[float] = None
) -> ConfidenceRoute:
    """
    Determine routing based on overall confidence score.

    USER DECISIONS from CONTEXT.md:
    - HIGH (>0.85): Write to database + log entry only, no notification
    - MEDIUM (0.6-0.85): Write immediately to database, notify dedicated review team
    - LOW (<0.6): Route to manual review queue, expire after 7 days

    Args:
        overall_confidence: Combined confidence score 0.0-1.0
        high_threshold: Override for high threshold (default from settings)
        low_threshold: Override for low threshold (default from settings)

    Returns:
        ConfidenceRoute with level, action, and context
    """
    # Use settings thresholds or overrides
    high_t = high_threshold if high_threshold is not None else settings.confidence_high_threshold
    low_t = low_threshold if low_threshold is not None else settings.confidence_low_threshold

    # Determine confidence level
    if overall_confidence >= high_t:
        level = ConfidenceLevel.HIGH
        action = RoutingAction.AUTO_UPDATE
        reason = f"Confidence {overall_confidence:.2f} >= {high_t:.2f} (high threshold)"
    elif overall_confidence >= low_t:
        level = ConfidenceLevel.MEDIUM
        action = RoutingAction.UPDATE_AND_NOTIFY
        reason = f"Confidence {overall_confidence:.2f} between {low_t:.2f} and {high_t:.2f}"
    else:
        level = ConfidenceLevel.LOW
        action = RoutingAction.MANUAL_REVIEW
        reason = f"Confidence {overall_confidence:.2f} < {low_t:.2f} (low threshold)"

    route = ConfidenceRoute(
        level=level,
        action=action,
        confidence=overall_confidence,
        high_threshold=high_t,
        low_threshold=low_t,
        reason=reason
    )

    logger.info(
        "confidence_route_determined",
        level=route.level.value,
        action=route.action.value,
        confidence=overall_confidence,
        high_threshold=high_t,
        low_threshold=low_t
    )

    return route


def get_review_expiration_days(level: ConfidenceLevel) -> Optional[int]:
    """
    Get expiration days for manual review items.

    USER DECISION: Low-confidence items expire after 7 days if not processed,
    then flag for batch review.

    Args:
        level: Confidence level

    Returns:
        Days until expiration, or None if no expiration
    """
    if level == ConfidenceLevel.LOW:
        return 7  # USER DECISION: 7-day expiration for low confidence
    return None  # MEDIUM and HIGH don't expire in queue
```

3. Update `app/services/confidence/__init__.py`:
   - Add imports for router module exports
   - Add to __all__: ConfidenceLevel, RoutingAction, ConfidenceRoute, route_by_confidence, get_review_expiration_days
  </action>
  <verify>
python -c "from app.services.confidence import route_by_confidence, ConfidenceRoute, RoutingAction; r = route_by_confidence(0.9); print(f'route: {r.action}')"
  </verify>
  <done>
- Settings includes confidence_high_threshold (0.85) and confidence_low_threshold (0.60)
- route_by_confidence returns ConfidenceRoute with level, action, and context
- HIGH (>0.85) -> AUTO_UPDATE
- MEDIUM (0.6-0.85) -> UPDATE_AND_NOTIFY
- LOW (<0.6) -> MANUAL_REVIEW
- Thresholds can be overridden for testing
- 7-day expiration for low-confidence items
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `python -c "from app.services.confidence import calculate_overall_confidence; print('ok')"`
2. `python -c "from app.services.confidence import route_by_confidence, RoutingAction; r = route_by_confidence(0.5); assert r.action == RoutingAction.MANUAL_REVIEW; print('low ok')"`
3. `python -c "from app.services.confidence import route_by_confidence, RoutingAction; r = route_by_confidence(0.75); assert r.action == RoutingAction.UPDATE_AND_NOTIFY; print('medium ok')"`
4. `python -c "from app.services.confidence import route_by_confidence, RoutingAction; r = route_by_confidence(0.90); assert r.action == RoutingAction.AUTO_UPDATE; print('high ok')"`
5. `python -c "from app.config import settings; print(f'high: {settings.confidence_high_threshold}, low: {settings.confidence_low_threshold}')"`
</verification>

<success_criteria>
- Overall confidence uses min() of extraction and match dimensions (REQ-CONFIDENCE-02)
- Three-tier routing works correctly based on thresholds (REQ-CONFIDENCE-03)
- HIGH (>0.85) routes to auto-update with log only
- MEDIUM (0.6-0.85) routes to update + notify
- LOW (<0.6) routes to manual review queue
- Thresholds configurable via CONFIDENCE_HIGH_THRESHOLD, CONFIDENCE_LOW_THRESHOLD env vars
</success_criteria>

<output>
After completion, create `.planning/phases/07-confidence-scoring-calibration/07-02-SUMMARY.md`
</output>
